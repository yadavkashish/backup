{% if block.settings.enable %}
<div id="app-reviews-root" 
     data-product-id="{{ product.id }}" 
     data-product-name="{{ product.title | escape }}"
     data-shop="{{ shop.permanent_domain }}">
</div>

<script>
async function initProductReviews() {
    const root = document.querySelector("#app-reviews-root");
    if (!root) return;

    const shop = root.dataset.shop;
    const productId = root.dataset.productId;
    const productName = root.dataset.productName;
    const API = "https://judgme.onrender.com"; 

    try {
        const [settingsRes, reviewsRes] = await Promise.all([
            fetch(`${API}/api/public/settings?shop=${shop}`),
            fetch(`${API}/api/public/reviews?productId=${productId}&shop=${shop}`)
        ]);

        const settingsData = await settingsRes.json();
        const reviewsData = await reviewsRes.json();

        const cfg = settingsData.config || {
            primaryColor: "#4A90E2",
            secondaryColor: "#64748b",
            starColor: "#fbbf24",
            buttonColor: "#008060",
            borderRadius: 12,
            shadowDepth: 4,
            fontSize: 14,
            showRatings: true
        };

        const styleTag = document.createElement('style');
        styleTag.innerHTML = `
            :root {
                --jd-primary: ${cfg.primaryColor};
                --jd-star: ${cfg.starColor};
                --jd-btn: ${cfg.buttonColor};
                --jd-text: ${cfg.secondaryColor};
                --jd-radius: ${cfg.borderRadius}px;
                --jd-shadow: 0 ${cfg.shadowDepth}px ${cfg.shadowDepth * 4}px rgba(0,0,0,0.1);
            }
            .jd-button-row { display: flex; gap: 12px; margin: 20px auto; max-width: 640px; }
            .jd-trigger-btn { 
                flex: 1; padding: 12px; border: 1px solid #e2e8f0; background: white; 
                border-radius: var(--jd-radius); cursor: pointer; font-weight: 700; 
                font-family: inherit; font-size: 14px; transition: all 0.2s;
            }
            .jd-trigger-btn:hover { background: #f8fafc; border-color: var(--jd-primary); }
            .jd-trigger-btn.active { border-color: var(--jd-primary); color: var(--jd-primary); background: #f0f7ff; }

            #jd-form-wrap, #jd-list-wrap { display: none; }

            .jd-card { 
                background: #fff; padding: 40px; border: 1px solid #e2e8f0;
                border-radius: var(--jd-radius); box-shadow: var(--jd-shadow);
                color: var(--jd-text); font-size: ${cfg.fontSize}px;
                font-family: 'Inter', -apple-system, sans-serif; max-width: 640px; margin: 0 auto 40px auto;
            }
            .jd-btn { 
                background: var(--jd-btn); color: white; padding: 14px; 
                border-radius: calc(var(--jd-radius) / 1.5); width: 100%; 
                border: none; cursor: pointer; font-weight: 700; margin-top: 20px;
                transition: opacity 0.2s;
            }
            .jd-btn:hover { opacity: 0.9; }
            .jd-input { 
                width: 100%; padding: 12px; margin: 8px 0 16px 0; border: 1px solid #e2e8f0;
                border-radius: calc(var(--jd-radius) / 1.5); color: var(--jd-text);
                font-size: inherit; outline: none; box-sizing: border-box;
            }
            .jd-star-row { font-size: 32px; color: var(--jd-star); cursor: pointer; margin-bottom: 24px; }
        `;
        document.head.appendChild(styleTag);

        root.innerHTML = `
            <div class="jd-button-row">
                <button class="jd-trigger-btn" id="btn-write-trigger"> Write a Review</button>
                <button class="jd-trigger-btn" id="btn-view-trigger">View Reviews (${reviewsData.length})</button>
            </div>

            <div id="jd-form-wrap">
                <div class="jd-card">
                    <div style="text-align:center; margin-bottom: 32px;">
                        <div style="font-size: 40px; color: var(--jd-star); margin-bottom: 12px;">★</div>
                        <h2 style="margin: 0; font-size: 24px; font-weight: 800;">Write a Review</h2>
                        <p style="opacity: 0.7;">Help others by sharing your experience.</p>
                    </div>

                    ${cfg.showRatings ? `
                        <label style="font-weight:700;">Your Rating *</label>
                        <div id="star-input" class="jd-star-row">
                            ${[1,2,3,4,5].map(i => `<span data-v="${i}">★</span>`).join('')}
                        </div>
                    ` : ''}

                    <label style="font-weight:700;">Name</label>
                    <input id="author-field" class="jd-input" placeholder="e.g. Jane Doe" />

                    <label style="font-weight:700;">Detailed Review *</label>
                    <textarea id="comment-field" class="jd-input" style="height:100px; resize: none;" placeholder="Tell us more..."></textarea>

                    <button id="submitBtn" class="jd-btn">Submit Review</button>
                    <p id="form-msg" style="margin-top:10px; text-align:center; font-weight:600;"></p>
                </div>
            </div>

            <div id="jd-list-wrap">
                <div class="jd-card">
                    <h3 style="font-size: 14px; color: #94a3b8; text-transform: uppercase; margin-bottom: 20px;">Recent Activity</h3>
                    <div id="reviews-list">
                        ${reviewsData.length === 0 ? '<p>No reviews yet. Be the first!</p>' : reviewsData.map(r => `
                            <div style="padding: 20px 0; border-bottom: 1px solid #f8fafc;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong>${r.author}</strong>
                                    <span style="font-size: 11px; color: #94a3b8;">${new Date(r.createdAt).toLocaleDateString()}</span>
                                </div>
                                <div style="color:var(--jd-star); margin: 4px 0;">${'★'.repeat(r.rating)}</div>
                                <p style="margin: 5px 0 10px 0; line-height: 1.5;">${r.comment}</p>
                                ${r.reply ? `
                                    <div style="margin-top: 15px; margin-left: 20px; padding: 12px 16px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid var(--jd-btn);">
                                        <span style="font-size: 12px; font-weight: 800; color: var(--jd-btn);">STORE RESPONSE</span>
                                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #334155;">${r.reply}</p>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        const formWrap = root.querySelector("#jd-form-wrap");
        const listWrap = root.querySelector("#jd-list-wrap");
        const btnWrite = root.querySelector("#btn-write-trigger");
        const btnView = root.querySelector("#btn-view-trigger");

        btnWrite.onclick = () => {
            formWrap.style.display = "block";
            listWrap.style.display = "none";
            btnWrite.classList.add("active");
            btnView.classList.remove("active");
        };

        btnView.onclick = () => {
            listWrap.style.display = "block";
            formWrap.style.display = "none";
            btnView.classList.add("active");
            btnWrite.classList.remove("active");
        };

        let currentRating = 5;
        const stars = root.querySelectorAll("#star-input span");
        stars.forEach(s => s.onclick = () => {
            currentRating = s.dataset.v;
            stars.forEach(star => star.style.opacity = star.dataset.v <= currentRating ? "1" : "0.3");
        });

        root.querySelector("#submitBtn").onclick = async () => {
            const author = root.querySelector("#author-field").value;
            const comment = root.querySelector("#comment-field").value;
            const msg = root.querySelector("#form-msg");

            if(!comment) {
                msg.style.color = "red";
                return msg.innerText = "Please write a comment.";
            }

            root.querySelector("#submitBtn").innerText = "Submitting...";
            root.querySelector("#submitBtn").disabled = true;

            try {
                const res = await fetch(`${API}/api/public/submit-review`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ shop, productId, productName, rating: currentRating, author: author || "Anonymous", comment })
                });

                if(res.ok) {
                    msg.style.color = "#10b981";
                    msg.innerText = "Thanks for your review!";
                    setTimeout(() => initProductReviews(), 2000);
                }
            } catch (err) {
                msg.style.color = "red";
                msg.innerText = "Error submitting review.";
                root.querySelector("#submitBtn").innerText = "Submit Review";
                root.querySelector("#submitBtn").disabled = false;
            }
        };

    } catch (e) {
        console.error("Widget Error:", e);
    }
}
initProductReviews();
</script>
{% endif %}

{% schema %}
{
  "name": "Product Reviews",
  "target": "section",
  "settings": [
    { "type": "checkbox", "id": "enable", "label": "Enable reviews", "default": true }
  ]
}
{% endschema %}