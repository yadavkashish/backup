{% if block.settings.enable %}
<div id="app-reviews-root" 
     data-product-id="{{ product.id }}" 
     data-shop="{{ shop.permanent_domain }}">
</div>

<script>
async function initProductReviews() {
    const root = document.querySelector("#app-reviews-root");
    if (!root) return;

    const shop = root.dataset.shop;
    const productId = root.dataset.productId;
    const API = "https://judgme.onrender.com"; // Ensure this matches your production URL

    try {
        // Fetch both datasets
        const [settingsRes, reviewsRes] = await Promise.all([
            fetch(`${API}/api/public/settings?shop=${shop}`),
            fetch(`${API}/api/public/reviews?productId=${productId}&shop=${shop}`)
        ]);

        if (!settingsRes.ok || !reviewsRes.ok) throw new Error("API Connection Failed");

        const settingsData = await settingsRes.json();
        const reviewsData = await reviewsRes.json();

        // Use saved config or defaults
        const cfg = settingsData.config || {
            primaryColor: "#4A90E2",
            secondaryColor: "#64748b",
            starColor: "#fbbf24",
            buttonColor: "#008060",
            borderRadius: 12,
            shadowDepth: 4,
            fontSize: 14
        };

        // Inject Styles and HTML as you had them
        const styleTag = document.createElement('style');
        styleTag.innerHTML = `
            :root {
                --jd-primary: ${cfg.primaryColor};
                --jd-star: ${cfg.starColor};
                --jd-btn: ${cfg.buttonColor};
                --jd-radius: ${cfg.borderRadius}px;
                --jd-shadow: 0 ${cfg.shadowDepth}px ${cfg.shadowDepth * 4}px rgba(0,0,0,0.1);
            }
            .jd-card { 
                background: #fff; padding: 30px; border: 1px solid #eee;
                border-radius: var(--jd-radius); box-shadow: var(--jd-shadow);
                color: ${cfg.secondaryColor}; font-size: ${cfg.fontSize}px;
            }
            .jd-btn { background: var(--jd-btn); color: white; padding: 12px; border-radius: 8px; width: 100%; border:none; cursor:pointer; }
            .jd-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
        `;
        document.head.appendChild(styleTag);

        root.innerHTML = `
            <div class="jd-card" style="max-width:600px; margin: 20px auto;">
                <h2 style="text-align:center">Customer Reviews</h2>
                <input id="author" class="jd-input" placeholder="Your Name" />
                <textarea id="comment" class="jd-input" style="height:80px" placeholder="Write a review..."></textarea>
                <button id="submitBtn" class="jd-btn">Submit Review</button>
                <div style="margin-top:20px">
                    ${reviewsData.length === 0 ? '<p>No reviews yet.</p>' : reviewsData.map(r => `
                        <div style="border-top:1px solid #eee; padding:10px 0;">
                            <strong>${r.author}</strong>
                            <div style="color:var(--jd-star)">${'â˜…'.repeat(r.rating)}</div>
                            <p>${r.comment}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } catch (e) {
        console.error("JUDGME WIDGET ERROR:", e);
    }
}
initProductReviews();
</script>
{% endif %}

{% schema %}
{
  "name": "Product Reviews",
  "target": "section",
  "settings": [
    { "type": "checkbox", "id": "enable", "label": "Enable reviews", "default": true }
  ]
}
{% endschema %}