{% if block.settings.enable %}
<div id="app-reviews-root" 
     data-product-id="{{ product.id }}" 
     data-shop="{{ shop.permanent_domain }}">
</div>

<script>
async function initProductReviews() {
    const root = document.querySelector("#app-reviews-root");
    if (!root) return;

    const shop = root.dataset.shop;
    const productId = root.dataset.productId;
    const API = "https://judgme.onrender.com";

    try {
        // FETCH CUSTOM DESIGN FROM YOUR DB
        const settingsRes = await fetch(`${API}/api/public/settings?shop=${shop}`).then(res => res.json());
        const reviewsRes = await fetch(`${API}/api/public/reviews?productId=${productId}&shop=${shop}`).then(res => res.json());

        const cfg = settingsRes.config || {
            primaryColor: "#4A90E2",
            secondaryColor: "#64748b",
            starColor: "#fbbf24",
            buttonColor: "#008060",
            borderRadius: 12,
            shadowDepth: 4,
            fontSize: 14
        };

        // INJECT THE DYNAMIC STYLES
        const styleTag = document.createElement('style');
        styleTag.innerHTML = `
            :root {
                --jd-primary: ${cfg.primaryColor};
                --jd-text: ${cfg.secondaryColor};
                --jd-star: ${cfg.starColor};
                --jd-btn: ${cfg.buttonColor};
                --jd-radius: ${cfg.borderRadius}px;
                --jd-shadow: 0 ${cfg.shadowDepth}px ${cfg.shadowDepth * 4}px rgba(0,0,0,0.1);
            }
            .jd-card { 
                background: #fff; padding: 30px; border: 1px solid #eee;
                border-radius: var(--jd-radius); box-shadow: var(--jd-shadow);
                color: var(--jd-text); font-size: ${cfg.fontSize}px;
            }
            .jd-btn { 
                background: var(--jd-btn); color: white; border: none; width: 100%;
                padding: 12px; border-radius: calc(var(--jd-radius) / 2); cursor: pointer;
            }
            .jd-input { 
                width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc;
                border-radius: calc(var(--jd-radius) / 2);
            }
        `;
        document.head.appendChild(styleTag);

        root.innerHTML = `
            <div class="jd-card" style="max-width:600px; margin: 20px auto;">
                <h2 style="text-align:center">Customer Reviews</h2>
                <div style="text-align:center; font-size:30px; color:var(--jd-star); margin-bottom:20px;">
                    ★★★★★
                </div>
                <input id="author" class="jd-input" placeholder="Your Name" />
                <textarea id="comment" class="jd-input" style="height:80px" placeholder="Write something..."></textarea>
                <button id="submitBtn" class="jd-btn">Submit Review</button>
                
                <div style="margin-top:30px">
                    ${reviewsRes.length === 0 ? '<p>No reviews yet.</p>' : reviewsRes.map(r => `
                        <div style="border-top:1px solid #eee; padding: 15px 0;">
                            <strong>${r.author}</strong>
                            <div style="color:var(--jd-star)">${'★'.repeat(r.rating)}</div>
                            <p>${r.comment}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        document.getElementById("submitBtn").onclick = () => alert("Logic connected!");

    } catch (e) {
        console.error("Widget load failed", e);
    }
}
initProductReviews();
</script>
{% endif %}

{% schema %}
{
  "name": "Product Reviews",
  "target": "section",
  "settings": [
    { "type": "checkbox", "id": "enable", "label": "Enable reviews", "default": true }
  ]
}
{% endschema %}