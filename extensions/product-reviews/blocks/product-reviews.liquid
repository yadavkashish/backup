{% if block.settings.enable %}
<div id="app-reviews-root" 
     data-product-id="{{ product.id }}" 
     data-product-name="{{ product.title | escape }}"
     data-shop="{{ shop.permanent_domain }}">
</div>

<script>
async function initProductReviews() {
  const root = document.querySelector("#app-reviews-root");
  if (!root) return;

  const shop = root.dataset.shop;
  const productId = root.dataset.productId;
  const productName = root.dataset.productName;
  const API = "https://judgme.onrender.com";

  try {
    const [settingsRes, reviewsRes] = await Promise.all([
      fetch(`${API}/api/public/settings?shop=${shop}`),
      fetch(`${API}/api/public/reviews?productId=${productId}&shop=${shop}`)
    ]);

    const settingsData = await settingsRes.json();
    const reviewsData = await reviewsRes.json();

    const cfg = settingsData.config || {
      starColor: "#f97316",
      buttonColor: "#2563eb",
      fontSize: 14
    };

    const style = document.createElement("style");
    style.innerHTML = `
      .jd-wrapper {
        display: flex;
        gap: 40px;
        align-items: flex-start;
        font-family: Arial, system-ui, sans-serif;
        font-size: ${cfg.fontSize}px;
        color: #111;
        margin: 40px 0;
      }

      .jd-left { width: 60%; }
      .jd-right {
        width: 40%;
        display: none;
        border-left: 1px solid #e5e7eb;
        padding-left: 32px;
      }

      .jd-title { font-size: 22px; font-weight: 700; margin-bottom: 16px; }

      .jd-review {
        padding: 24px 0;
        border-bottom: 1px solid #e5e7eb;
      }

      .jd-review-header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 6px;
      }

      .jd-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
      }

      .jd-author { font-weight: 700; }

      .jd-stars {
        color: ${cfg.starColor};
        font-size: 14px;
        margin: 4px 0;
      }

      .jd-meta {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .jd-write-btn {
        margin: 24px 0;
        padding: 12px 18px;
        border-radius: 999px;
        border: 1px solid #111;
        background: #fff;
        cursor: pointer;
        font-weight: 600;
      }

      .jd-input {
        width: 100%;
        padding: 10px;
        margin: 8px 0 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-sizing: border-box;
      }

      .jd-submit {
        width: 100%;
        padding: 12px;
        background: ${cfg.buttonColor};
        color: #fff;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }

      .jd-star-input span {
        font-size: 28px;
        cursor: pointer;
        color: ${cfg.starColor};
        opacity: 0.3;
      }
    `;
    document.head.appendChild(style);

    root.innerHTML = `
      <div class="jd-wrapper">
        <div class="jd-left">
          <div class="jd-title">Customer reviews</div>
          <button id="openFormBtn" class="jd-write-btn">Write a product review</button>

          <div id="reviews-container">
            ${reviewsData.length === 0 ? `<p>No reviews yet.</p>` : reviewsData.map(r => `
              <div class="jd-review">
                <div class="jd-review-header">
                  <div class="jd-avatar">${r.author.charAt(0).toUpperCase()}</div>
                  <div class="jd-author">${r.author}</div>
                </div>
                <div class="jd-stars">
                  ${"★".repeat(r.rating)}${"☆".repeat(5 - r.rating)}
                </div>
                <div class="jd-meta">
                  Reviewed on ${new Date(r.createdAt).toLocaleDateString()}
                  
                </div>
                <div>${r.comment}</div>
              </div>
            `).join("")}
          </div>
        </div>

        <div class="jd-right" id="reviewForm">
          <h3>Review this product</h3>
          <label>Your Rating *</label>
          <div class="jd-star-input" id="starInput">
            ${[1,2,3,4,5].map(i => `<span data-v="${i}">★</span>`).join("")}
          </div>
          <label>Name</label>
          <input id="author-field" class="jd-input" placeholder="Your name">
          <label>Write your review *</label>
          <textarea id="comment-field" class="jd-input" style="height:120px"></textarea>
          <button id="submitBtn" class="jd-submit">Submit Review</button>
          <p id="form-msg" style="margin-top:10px; text-align:center;"></p>
        </div>
      </div>
    `;

    document.getElementById("openFormBtn").onclick = () => {
      document.getElementById("reviewForm").style.display = "block";
    };

    let currentRating = 5;
    const stars = document.querySelectorAll("#starInput span");
    const updateStars = (val) => {
      stars.forEach(s => s.style.opacity = s.dataset.v <= val ? "1" : "0.3");
    };

    stars.forEach(star => {
      star.onclick = () => {
        currentRating = star.dataset.v;
        updateStars(currentRating);
      };
    });
    updateStars(5);

    document.getElementById("submitBtn").onclick = async () => {
      const author = document.getElementById("author-field").value;
      const comment = document.getElementById("comment-field").value;
      const msg = document.getElementById("form-msg");

      if (!comment) {
        msg.style.color = "red";
        msg.innerText = "Please write a review.";
        return;
      }

      msg.style.color = "black";
      msg.innerText = "Submitting...";

      try {
        const res = await fetch(`${API}/api/public/reviews`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            shop, productId, productName,
            rating: currentRating,
            author: author || "Anonymous",
            comment
          })
        });

        if (res.ok) {
          msg.style.color = "green";
          msg.innerText = "Thanks for your review!";
          setTimeout(() => initProductReviews(), 1500);
        } else {
          throw new Error();
        }
      } catch {
        msg.style.color = "red";
        msg.innerText = "Error submitting review.";
      }
    };

  } catch (e) {
    console.error("Widget Error", e);
  }
}
initProductReviews();
</script>
{% endif %}

{% schema %}
{
  "name": "Product Reviews",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable",
      "label": "Enable reviews",
      "default": true
    }
  ]
}
{% endschema %}