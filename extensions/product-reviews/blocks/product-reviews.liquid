{% if block.settings.enable %}
<div id="app-reviews-root" 
     data-product-id="{{ product.id }}" 
     data-product-name="{{ product.title | escape }}"
     data-shop="{{ shop.permanent_domain }}">
</div>

<script>
async function initProductReviews() {
  const root = document.querySelector("#app-reviews-root");
  if (!root) return;

  const shop = root.dataset.shop;
  const productId = root.dataset.productId;
  const productName = root.dataset.productName;
  const API = "https://backup-jet.vercel.app";

  try {
    const [settingsRes, reviewsRes] = await Promise.all([
      fetch(`${API}/api/public/settings?shop=${shop}`),
      fetch(`${API}/api/public/reviews?productId=${productId}&shop=${shop}`)
    ]);

    const settingsData = await settingsRes.json();
    const reviewsData = await reviewsRes.json();

    const cfg = settingsData.config || {
      starColor: "#f97316",
      buttonColor: "#111111",
      fontSize: 14
    };

    const style = document.createElement("style");
    style.innerHTML = `
      .jd-wrapper {
        max-width: 1200px;
        margin: 60px auto;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        color: #1a1a1a;
      }
      .jd-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        border-bottom: 1px solid #eeeeee;
        padding-bottom: 16px;
      }
      .jd-title { font-size: 24px; font-weight: 600; margin: 0; }

      .jd-review-item {
        margin-bottom: 32px;
        padding-bottom: 32px;
        border-bottom: 1px solid #f5f5f5;
      }

      .jd-review-main {
        display: flex;
        gap: 16px;
      }

      .jd-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
        color: #666;
      }

      .jd-content { flex: 1; }

      .jd-author-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }
      .jd-author-name { font-weight: 600; font-size: 15px; }
      
      .jd-stars {
        color: ${cfg.starColor};
        letter-spacing: 2px;
        font-size: 14px;
        margin-bottom: 8px;
      }

      .jd-meta-date {
        font-size: 12px;
        color: #888;
        margin-bottom: 12px;
      }

      .jd-text {
        font-size: 15px;
        line-height: 1.6;
        color: #333;
      }

      /* --- Threaded Reply UI --- */
      .jd-reply-container {
        position: relative;
        margin-left: 60px; /* Aligns with the review text start */
        margin-top: 20px;
        padding-left: 24px;
      }

      /* The vertical thread line */
      .jd-reply-container::before {
        content: "";
        position: absolute;
        left: 0;
        top: -10px;
        bottom: 10px;
        width: 2px;
        background: #eeeeee;
        border-radius: 2px;
      }

      .jd-reply-header {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        font-weight: 600;
        color: #111;
        margin-bottom: 6px;
      }

      .jd-reply-badge {
        background: #111;
        color: #fff;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        text-transform: uppercase;
      }

      .jd-reply-text {
        font-size: 14px;
        line-height: 1.5;
        color: #555;
        font-style: normal;
      }

      .jd-write-btn {
        padding: 12px 24px;
        border-radius: 4px;
        border: 1px solid #111;
        background: #111;
        color: #fff;
        cursor: pointer;
        font-weight: 500;
        transition: opacity 0.2s;
      }
      .jd-write-btn:hover { opacity: 0.8; }

      .jd-form-drawer {
        display: none;
        background: #fcfcfc;
        padding: 24px;
        border-radius: 8px;
        border: 1px solid #eee;
        margin-bottom: 40px;
      }
    `;
    document.head.appendChild(style);

    root.innerHTML = `
      <div class="jd-wrapper">
        <div class="jd-header">
          <h2 class="jd-title">Customer Reviews</h2>
          <button id="openFormBtn" class="jd-write-btn">Write a Review</button>
        </div>

        <div id="reviewForm" class="jd-form-drawer">
          <h3 style="margin-top:0">Share your thoughts</h3>
          <div class="jd-star-input" id="starInput" style="margin-bottom:15px">
            ${[1,2,3,4,5].map(i => `<span data-v="${i}" style="font-size:30px; cursor:pointer">★</span>`).join("")}
          </div>
          <input id="author-field" class="jd-input" placeholder="Display Name (e.g. Jane D.)" style="display:block; width:100%; padding:12px; margin-bottom:12px; border:1px solid #ddd">
          <textarea id="comment-field" class="jd-input" placeholder="What did you like or dislike?" style="display:block; width:100%; height:100px; padding:12px; border:1px solid #ddd"></textarea>
          <button id="submitBtn" class="jd-write-btn" style="margin-top:12px; width:100%">Post Review</button>
          <p id="form-msg" style="text-align:center; margin-top:12px"></p>
        </div>

        <div id="reviews-container">
          ${reviewsData.length === 0 ? `<p style="color:#666">Be the first to review this product.</p>` : reviewsData.map(r => `
            <div class="jd-review-item">
              <div class="jd-review-main">
                <div class="jd-avatar">${r.author.charAt(0).toUpperCase()}</div>
                <div class="jd-content">
                  <div class="jd-author-row">
                    <span class="jd-author-name">${r.author}</span>
                  </div>
                  <div class="jd-stars">${"★".repeat(r.rating)}${"☆".repeat(5 - r.rating)}</div>
                  <div class="jd-meta-date">Published ${new Date(r.createdAt).toLocaleDateString()}</div>
                  <div class="jd-text">${r.comment}</div>
                  
                  ${r.reply ? `
                    <div class="jd-reply-container">
                      <div class="jd-reply-header">
                        <span class="jd-reply-badge">Store</span>
                        Official Response
                      </div>
                      <div class="jd-reply-text">${r.reply}</div>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    `;

    // --- Interaction Logic ---
    document.getElementById("openFormBtn").onclick = () => {
      const form = document.getElementById("reviewForm");
      form.style.display = form.style.display === "block" ? "none" : "block";
    };

    let currentRating = 5;
    const stars = document.querySelectorAll("#starInput span");
    const updateStars = (val) => {
      stars.forEach(s => {
        s.style.color = s.dataset.v <= val ? cfg.starColor : "#ddd";
      });
    };

    stars.forEach(star => {
      star.onclick = () => {
        currentRating = star.dataset.v;
        updateStars(currentRating);
      };
    });
    updateStars(5);

    document.getElementById("submitBtn").onclick = async () => {
      const author = document.getElementById("author-field").value;
      const comment = document.getElementById("comment-field").value;
      const msg = document.getElementById("form-msg");

      if (!comment) {
        msg.innerHTML = "Please add a comment.";
        return;
      }

      msg.innerHTML = "Submitting...";

      try {
        const res = await fetch(`${API}/api/public/reviews`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            shop, productId, productName,
            rating: currentRating,
            author: author || "Anonymous",
            comment
          })
        });

        if (res.ok) {
          msg.innerHTML = "Success! Your review is live.";
          setTimeout(() => initProductReviews(), 1500);
        } else {
          throw new Error();
        }
      } catch {
        msg.innerHTML = "Error submitting review.";
      }
    };

  } catch (e) {
    console.error("Widget Error", e);
  }
}
initProductReviews();
</script>
{% endif %}